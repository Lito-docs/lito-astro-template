---
import Layout from './Layout.astro';
import Footer from '../components/Footer.astro';
import TableOfContents from '../components/TableOfContents.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import PrevNextNav from '../components/PrevNextNav.astro';
import VersionBanner from '../components/VersionBanner.astro';
import CopyPageButton from '../components/CopyPageButton.astro';
import EditPageLink from '../components/EditPageLink.astro';
import LastUpdated from '../components/LastUpdated.astro';
import PageFeedback from '../components/PageFeedback.astro';
import type { SEOFrontmatter } from '../types/seo';
import { getConfigFile } from '../utils/config';

interface Props {
  title: string;
  description?: string;
  sourceFile?: string;
  frontmatter?: SEOFrontmatter & {
    title?: string;
    description?: string;
  };
}

const { frontmatter, sourceFile } = Astro.props;
const title = Astro.props.title || frontmatter?.title || '';
const description = Astro.props.description || frontmatter?.description;

// Build breadcrumbs for SEO JSON-LD
const config = await getConfigFile();
const { pathname } = Astro.url;
const currentSlug = pathname.replace(/^\/|\/$/g, '');

const breadcrumbs: Array<{ name: string; href?: string }> = [
  { name: 'Docs', href: '/' }
];

// Find current page in sidebar config
let found = false;
for (const group of config.navigation.sidebar) {
  if (found) break;
  if (group.items) {
    for (const item of group.items) {
      const itemPath = item.href || item.slug || '';
      const itemSlug = itemPath.replace(/^\/|\/$/g, '');
      if (itemSlug === currentSlug) {
        breadcrumbs.push({ name: group.label });
        breadcrumbs.push({ name: item.label, href: itemPath });
        found = true;
        break;
      }
    }
  }
}

// Fallback for unlisted pages
if (!found && currentSlug) {
  const segments = currentSlug.split('/');
  segments.forEach((segment, index) => {
    const isLast = index === segments.length - 1;
    breadcrumbs.push({
      name: segment.charAt(0).toUpperCase() + segment.slice(1),
      href: isLast ? undefined : `/${segments.slice(0, index + 1).join('/')}`,
    });
  });
}
---

<Layout title={title} description={description} frontmatter={frontmatter} breadcrumbs={breadcrumbs}>
  <main class="main-content pt-16">
    <article class="docs-prose">
      <div class="article-header">
        <Breadcrumbs />
        <CopyPageButton />
      </div>
      <VersionBanner />
      <slot />
      <div class="article-footer-meta">
        <LastUpdated frontmatter={frontmatter} />
        <EditPageLink sourceFile={sourceFile} />
      </div>
      <PageFeedback />
      <PrevNextNav />
    </article>
    <Footer />
  </main>
  <TableOfContents />
</Layout>

<script>
  function wrapTables() {
    const prose = document.querySelector('.docs-prose');
    if (!prose) return;
    prose.querySelectorAll('table').forEach((table) => {
      if (table.parentElement?.classList.contains('table-scroll-wrapper')) return;
      const wrapper = document.createElement('div');
      wrapper.className = 'table-scroll-wrapper';
      table.parentNode?.insertBefore(wrapper, table);
      wrapper.appendChild(table);
    });
  }
  wrapTables();
  document.addEventListener('astro:page-load', wrapTables);
</script>
