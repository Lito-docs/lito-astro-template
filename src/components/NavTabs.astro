---
import type { NavTab, SidebarItem } from '../types/config';
import { getConfigFile, getLocalizedSidebar } from '../utils/config';
import { getI18nConfig, getLocaleFromPath } from '../utils/i18n';
import { createLink } from '../utils/url';
import Icon from './Icon.astro';

interface Props {
  tabs: NavTab[];
}

const { tabs } = Astro.props;
const currentPath = Astro.url.pathname;
const normalizedPath = currentPath.replace(/\/$/, '') || '/';

// Load sidebar for group-membership matching
const i18nConfig = await getI18nConfig();
const currentLocale = getLocaleFromPath(currentPath, i18nConfig.locales) || i18nConfig.defaultLocale;
const sidebarItems = getLocalizedSidebar(currentLocale, i18nConfig.defaultLocale);

function collectHrefs(items: SidebarItem[]): string[] {
  const hrefs: string[] = [];
  for (const item of items) {
    if (item.href) hrefs.push(item.href.replace(/\/$/, '') || '/');
    if (item.slug) hrefs.push(`/${item.slug}`.replace(/\/$/, '') || '/');
    if (item.items) hrefs.push(...collectHrefs(item.items));
  }
  return hrefs;
}

const isTabActive = (tab: NavTab) => {
  // If tab has groups, check if current page belongs to any of those groups
  if (tab.groups?.length) {
    const groupItems = sidebarItems.filter((g: any) => tab.groups!.includes(g.label));
    return groupItems.some((g: any) => collectHrefs(g.items || []).includes(normalizedPath));
  }
  // Fallback: URL prefix matching
  const match = tab.match || tab.href;
  const normalizedMatch = match.replace(/\/$/, '') || '/';
  return normalizedPath === normalizedMatch || normalizedPath.startsWith(normalizedMatch + '/');
};
---

<nav class="nav-tabs" aria-label="Section navigation">
  <div class="nav-tabs-inner">
    {tabs.map((tab) => (
      <a
        href={createLink(tab.href)}
        class:list={['nav-tab', { 'nav-tab-active': isTabActive(tab) }]}
        aria-current={isTabActive(tab) ? 'true' : undefined}
      >
        {tab.icon && <Icon name={tab.icon} size={14} class="nav-tab-icon" />}
        <span>{tab.label}</span>
      </a>
    ))}
  </div>
</nav>

<style>
  @reference "../styles/global.css";

  .nav-tabs {
    @apply sticky z-40;
    top: 4rem;
    background: oklch(from var(--background) l c h / 0.95);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
  }

  .nav-tabs-inner {
    @apply flex items-center gap-0 px-4 md:px-6 overflow-x-auto;
    scrollbar-width: none;
  }

  .nav-tabs-inner::-webkit-scrollbar {
    display: none;
  }

  .nav-tab {
    @apply flex items-center gap-1.5 px-3 py-2.5 text-sm font-medium whitespace-nowrap;
    @apply transition-colors duration-150;
    color: var(--muted-foreground);
    text-decoration: none;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
  }

  .nav-tab:hover {
    color: var(--foreground);
  }

  .nav-tab-active {
    color: var(--foreground);
    border-bottom-color: var(--primary-500);
  }

  .nav-tab-icon {
    opacity: 0.7;
  }

  .nav-tab-active .nav-tab-icon {
    opacity: 1;
  }
</style>
