---
/**
 * VersionSwitcher - Dropdown for switching between documentation versions
 *
 * Displays in the header when versioning is enabled and multiple versions exist.
 */
import Icon from './Icon.astro';
import { getConfigFile } from '../utils/config';
import {
  getVersionFromPath,
  buildVersionedPath,
  type VersioningConfig,
  type Version,
} from '../utils/versioning';

const config = await getConfigFile();
const versioningConfig = config.versioning as VersioningConfig | undefined;

// Only render if versioning is enabled and there are multiple versions
if (!versioningConfig?.enabled || !versioningConfig.versions?.length || versioningConfig.versions.length <= 1) {
  return null;
}

const currentPath = Astro.url.pathname;
const currentVersion = getVersionFromPath(currentPath, versioningConfig);
const versions = versioningConfig.versions;
---

<div class="version-switcher relative" id="version-switcher">
  <button
    id="version-switcher-btn"
    class="version-button"
    aria-label="Switch documentation version"
    aria-expanded="false"
    aria-haspopup="listbox"
  >
    <Icon name="lucide:git-branch" size={16} />
    <span class="version-label">{currentVersion?.label || 'Version'}</span>
    <Icon name="lucide:chevron-down" size={14} class="chevron" />
  </button>

  <div id="version-dropdown" class="version-dropdown hidden" role="listbox">
    {versions.map((version: Version) => {
      const href = buildVersionedPath(currentPath, version, versioningConfig);
      const isActive = version.id === currentVersion?.id;
      const isDeprecated = version.deprecated;

      return (
        <a
          href={href}
          class={`version-option ${isActive ? 'active' : ''}`}
          role="option"
          aria-selected={isActive ? 'true' : 'false'}
        >
          <span class="version-name">
            {version.label}
            {isDeprecated && <span class="deprecated-badge">Deprecated</span>}
          </span>
          {isActive && <Icon name="lucide:check" size={14} class="check-icon" />}
        </a>
      );
    })}
  </div>
</div>

<script>
  const switcher = document.getElementById('version-switcher');
  const btn = document.getElementById('version-switcher-btn');
  const dropdown = document.getElementById('version-dropdown');

  if (btn && dropdown) {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isHidden = dropdown.classList.contains('hidden');
      dropdown.classList.toggle('hidden');
      btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
    });

    // Close on outside click
    document.addEventListener('click', (e) => {
      if (switcher && !switcher.contains(e.target as Node)) {
        dropdown.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
      }
    });

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !dropdown.classList.contains('hidden')) {
        dropdown.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
        btn.focus();
      }
    });
  }
</script>

<style>
  .version-switcher {
    position: relative;
    font-family: var(--font-sans);
  }

  .version-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    background: var(--muted);
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--foreground);
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .version-button:hover {
    background: var(--accent);
    border-color: var(--primary-300);
  }

  .version-label {
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .chevron {
    transition: transform 0.2s ease;
  }

  .version-button[aria-expanded='true'] .chevron {
    transform: rotate(180deg);
  }

  .version-dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 180px;
    max-width: 250px;
    padding: 0.375rem;
    background: var(--popover);
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    box-shadow:
      0 4px 20px -4px rgba(0, 0, 0, 0.15),
      0 2px 8px -2px rgba(0, 0, 0, 0.1);
    z-index: 50;
    opacity: 1;
    transform: translateY(0);
    transition: all 0.15s ease;
  }

  .version-dropdown.hidden {
    opacity: 0;
    transform: translateY(-0.5rem);
    pointer-events: none;
  }

  .version-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    color: var(--foreground);
    text-decoration: none;
    border-radius: 0.375rem;
    transition: background 0.1s ease;
  }

  .version-option:hover {
    background: var(--muted);
  }

  .version-option.active {
    background: var(--primary-100);
    color: var(--primary-700);
  }

  :global(.dark) .version-option.active {
    background: var(--primary-900);
    color: var(--primary-300);
  }

  .version-name {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .deprecated-badge {
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    padding: 0.125rem 0.375rem;
    background: var(--warning-light);
    color: var(--warning);
    border-radius: 0.25rem;
  }

  .check-icon {
    color: var(--primary-500);
    flex-shrink: 0;
  }
</style>
