---
/**
 * APITryIt - Collapsible interactive API playground
 * Slimmed-down version â€” sits at the bottom of the right panel, collapsed by default.
 */
import Icon from '../Icon.astro';

interface Props {
  method: string;
  path: string;
  baseUrl: string;
  auth: string;
}

const { method, path, baseUrl, auth } = Astro.props;
const tryItId = `tryit-${Math.random().toString(36).slice(2, 9)}`;
const defaultHeaders = JSON.stringify({ 'Content-Type': 'application/json' });
---

<div
  class="api-tryit not-prose"
  id={tryItId}
  data-method={method}
  data-path={path}
  data-base-url={baseUrl}
  data-auth={auth}
  data-default-headers={defaultHeaders}
>
  <!-- Collapse Toggle -->
  <button class="tryit-toggle" aria-expanded="false" data-tryit-toggle>
    <span class="tryit-toggle-inner">
      <Icon name="lucide:play" size={14} />
      <span>Try it</span>
    </span>
    <svg class="tryit-chevron" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="m6 9 6 6 6-6"/>
    </svg>
  </button>

  <!-- Collapsible Content -->
  <div class="tryit-content" hidden data-tryit-content>
    <!-- URL Bar -->
    <div class="tryit-url-bar">
      <span class={`tryit-method tryit-method-${method.toLowerCase()}`}>{method}</span>
      <input type="text" class="tryit-base-url" placeholder="https://api.example.com" value={baseUrl} aria-label="Base URL" />
      <code class="tryit-path">{path}</code>
    </div>

    <!-- Auth -->
    {auth && auth !== 'none' && (
      <div class="tryit-section">
        <div class="tryit-section-label">
          <Icon name="lucide:lock" size={12} />
          <span>Authorization</span>
        </div>
        <div class="tryit-auth-inputs">
          {auth === 'bearer' && (
            <input type="text" class="tryit-input auth-token-input" placeholder="Bearer token" />
          )}
          {auth === 'api-key' && (
            <>
              <input type="text" class="tryit-input auth-key-input" placeholder="Header name" value="X-API-Key" />
              <input type="text" class="tryit-input auth-value-input" placeholder="API key" />
            </>
          )}
          {auth === 'basic' && (
            <>
              <input type="text" class="tryit-input auth-user-input" placeholder="Username" />
              <input type="password" class="tryit-input auth-pass-input" placeholder="Password" />
            </>
          )}
        </div>
      </div>
    )}

    <!-- Headers -->
    <div class="tryit-section">
      <div class="tryit-section-label">
        <Icon name="lucide:file-text" size={12} />
        <span>Headers</span>
      </div>
      <div class="tryit-kv headers-editor">
        <div class="tryit-kv-row template" style="display:none">
          <input type="text" placeholder="Key" class="tryit-input kv-key" />
          <input type="text" placeholder="Value" class="tryit-input kv-value" />
          <button class="tryit-kv-remove" aria-label="Remove">
            <Icon name="lucide:x" size={12} />
          </button>
        </div>
      </div>
      <button class="tryit-add-btn" data-target="headers">
        <Icon name="lucide:plus" size={12} />
        Add Header
      </button>
    </div>

    <!-- Body (for POST/PUT/PATCH) -->
    {['POST', 'PUT', 'PATCH'].includes(method) && (
      <div class="tryit-section">
        <div class="tryit-section-label">
          <Icon name="lucide:braces" size={12} />
          <span>Body</span>
        </div>
        <textarea class="tryit-body" placeholder='{"key": "value"}'></textarea>
      </div>
    )}

    <!-- Send Button -->
    <div class="tryit-actions">
      <button class="tryit-send-btn">
        <Icon name="lucide:play" size={14} />
        Send Request
      </button>
    </div>

    <!-- Response -->
    <div class="tryit-response" hidden data-tryit-response>
      <div class="tryit-response-header">
        <span class="tryit-response-label">Response</span>
        <span class="tryit-status-badge"></span>
        <span class="tryit-response-time"></span>
      </div>
      <pre class="tryit-response-body"><code></code></pre>
    </div>
  </div>
</div>

<style>
  @reference "../../styles/global.css";

  .api-tryit {
    @apply rounded-xl overflow-hidden mt-4;
    border: 1px solid var(--border);
    background: var(--card);
  }

  .tryit-toggle {
    @apply w-full flex items-center justify-between px-4 py-3;
    @apply text-sm font-medium transition-colors duration-150;
    color: var(--muted-foreground);
  }

  .tryit-toggle:hover {
    color: var(--foreground);
    background: var(--accent);
  }

  .tryit-toggle-inner {
    @apply flex items-center gap-2;
  }

  .tryit-chevron {
    @apply transition-transform duration-200;
  }

  .api-tryit.open .tryit-chevron {
    transform: rotate(180deg);
  }

  .tryit-content {
    @apply border-t border-border;
  }

  /* URL Bar */
  .tryit-url-bar {
    @apply flex items-center gap-2 px-4 py-3 bg-muted/50 flex-wrap;
    border-bottom: 1px solid var(--border);
  }

  .tryit-method {
    @apply px-2 py-1 text-xs font-bold uppercase rounded-md flex-shrink-0;
  }

  .tryit-method-get { @apply bg-emerald-500/15 text-emerald-600; }
  :global(.dark) .tryit-method-get { @apply text-emerald-400; }
  .tryit-method-post { @apply bg-blue-500/15 text-blue-600; }
  :global(.dark) .tryit-method-post { @apply text-blue-400; }
  .tryit-method-put { @apply bg-amber-500/15 text-amber-600; }
  :global(.dark) .tryit-method-put { @apply text-amber-400; }
  .tryit-method-patch { @apply bg-orange-500/15 text-orange-600; }
  :global(.dark) .tryit-method-patch { @apply text-orange-400; }
  .tryit-method-delete { @apply bg-red-500/15 text-red-600; }
  :global(.dark) .tryit-method-delete { @apply text-red-400; }

  .tryit-base-url {
    @apply px-2.5 py-1.5 text-xs bg-background border border-border rounded-md;
    @apply focus:outline-none focus:ring-2 focus:ring-primary-500/30;
    @apply text-foreground w-40;
  }

  .tryit-path {
    @apply text-xs font-mono text-foreground truncate;
  }

  /* Sections */
  .tryit-section {
    @apply px-4 py-3;
    border-bottom: 1px solid var(--border);
  }

  .tryit-section-label {
    @apply flex items-center gap-1.5 text-xs font-medium text-muted-foreground mb-2;
  }

  .tryit-input {
    @apply px-2.5 py-1.5 text-xs bg-background border border-border rounded-md;
    @apply focus:outline-none focus:ring-2 focus:ring-primary-500/30;
    @apply text-foreground;
  }

  .tryit-auth-inputs {
    @apply flex items-center gap-2 flex-wrap;
  }

  .tryit-auth-inputs .tryit-input {
    @apply flex-1 min-w-[100px];
  }

  /* KV Editor */
  .tryit-kv {
    @apply space-y-1.5;
  }

  .tryit-kv-row {
    @apply flex items-center gap-1.5;
  }

  .tryit-kv-row .kv-key,
  .tryit-kv-row .kv-value {
    @apply flex-1;
  }

  .tryit-kv-remove {
    @apply p-1.5 text-muted-foreground hover:text-red-500;
    @apply rounded hover:bg-red-500/10 transition-colors;
  }

  .tryit-add-btn {
    @apply inline-flex items-center gap-1 mt-2 px-2 py-1;
    @apply text-xs font-medium text-primary-600;
    @apply hover:bg-primary-500/10 rounded transition-colors;
  }

  :global(.dark) .tryit-add-btn {
    @apply text-primary-400;
  }

  /* Body */
  .tryit-body {
    @apply w-full h-28 px-3 py-2 text-xs font-mono;
    @apply bg-background border border-border rounded-md;
    @apply focus:outline-none focus:ring-2 focus:ring-primary-500/30;
    @apply text-foreground resize-none;
  }

  /* Actions */
  .tryit-actions {
    @apply px-4 py-3;
  }

  .tryit-send-btn {
    @apply inline-flex items-center gap-2 px-4 py-2 w-full justify-center;
    @apply text-sm font-semibold text-primary-foreground;
    @apply bg-primary-600 hover:bg-primary-700 rounded-lg;
    @apply transition-colors duration-150;
  }

  :global(.dark) .tryit-send-btn {
    @apply bg-primary-500 hover:bg-primary-600;
  }

  /* Response */
  .tryit-response {
    @apply border-t border-border;
  }

  .tryit-response-header {
    @apply flex items-center gap-3 px-4 py-2.5 bg-muted/50;
    border-bottom: 1px solid var(--border);
  }

  .tryit-response-label {
    @apply text-xs font-semibold text-foreground;
  }

  .tryit-status-badge {
    @apply px-2 py-0.5 text-xs font-mono font-semibold rounded;
  }

  .tryit-status-badge.success {
    @apply bg-emerald-500/15 text-emerald-600;
  }
  :global(.dark) .tryit-status-badge.success { @apply text-emerald-400; }

  .tryit-status-badge.error {
    @apply bg-red-500/15 text-red-600;
  }
  :global(.dark) .tryit-status-badge.error { @apply text-red-400; }

  .tryit-response-time {
    @apply text-xs text-muted-foreground;
  }

  .tryit-response-body {
    @apply p-4 text-xs font-mono overflow-x-auto m-0;
    background: var(--muted);
    color: var(--foreground);
    max-height: 300px;
  }

  .tryit-response-body code {
    color: inherit;
    font-family: inherit;
  }
</style>

<script>
  function initTryIt(container: HTMLElement) {
    const toggle = container.querySelector('[data-tryit-toggle]');
    const content = container.querySelector('[data-tryit-content]') as HTMLElement;
    const method = container.dataset.method || 'GET';
    const path = container.dataset.path || '';
    const auth = container.dataset.auth;
    const defaultHeaders = JSON.parse(container.dataset.defaultHeaders || '{}');

    // Toggle expand/collapse
    toggle?.addEventListener('click', () => {
      const isOpen = container.classList.toggle('open');
      toggle.setAttribute('aria-expanded', String(isOpen));
      if (content) content.hidden = !isOpen;
    });

    // Add row functionality
    function addRow(editor: Element, key = '', value = '') {
      const template = editor.querySelector('.tryit-kv-row.template');
      if (!template) return;
      const row = template.cloneNode(true) as HTMLElement;
      row.classList.remove('template');
      row.style.display = '';
      const keyInput = row.querySelector('.kv-key') as HTMLInputElement;
      const valueInput = row.querySelector('.kv-value') as HTMLInputElement;
      if (keyInput) keyInput.value = key;
      if (valueInput) valueInput.value = value;
      row.querySelector('.tryit-kv-remove')?.addEventListener('click', () => row.remove());
      editor.appendChild(row);
    }

    // Init default headers
    const headersEditor = container.querySelector('.headers-editor');
    if (headersEditor) {
      Object.entries(defaultHeaders).forEach(([key, value]) => {
        addRow(headersEditor, key, value as string);
      });
    }

    // Add row buttons
    container.querySelectorAll('.tryit-add-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = (btn as HTMLElement).dataset.target;
        const editor = container.querySelector(`.${target}-editor`);
        if (editor) addRow(editor);
      });
    });

    // Send request
    container.querySelector('.tryit-send-btn')?.addEventListener('click', async () => {
      const baseUrl = (container.querySelector('.tryit-base-url') as HTMLInputElement)?.value || '';

      // Collect headers
      const headers: Record<string, string> = {};
      container.querySelectorAll('.headers-editor .tryit-kv-row:not(.template)').forEach(row => {
        const key = (row.querySelector('.kv-key') as HTMLInputElement)?.value;
        const value = (row.querySelector('.kv-value') as HTMLInputElement)?.value;
        if (key) headers[key] = value || '';
      });

      // Auth
      if (auth === 'bearer') {
        const token = (container.querySelector('.auth-token-input') as HTMLInputElement)?.value;
        if (token) headers['Authorization'] = `Bearer ${token}`;
      } else if (auth === 'api-key') {
        const key = (container.querySelector('.auth-key-input') as HTMLInputElement)?.value;
        const value = (container.querySelector('.auth-value-input') as HTMLInputElement)?.value;
        if (key && value) headers[key] = value;
      } else if (auth === 'basic') {
        const user = (container.querySelector('.auth-user-input') as HTMLInputElement)?.value;
        const pass = (container.querySelector('.auth-pass-input') as HTMLInputElement)?.value;
        if (user) headers['Authorization'] = `Basic ${btoa(`${user}:${pass}`)}`;
      }

      const body = (container.querySelector('.tryit-body') as HTMLTextAreaElement)?.value || '';
      let url = baseUrl + path;

      const responseSection = container.querySelector('[data-tryit-response]') as HTMLElement;
      const statusBadge = container.querySelector('.tryit-status-badge');
      const timeEl = container.querySelector('.tryit-response-time');
      const bodyEl = container.querySelector('.tryit-response-body code');

      try {
        const startTime = performance.now();
        const response = await fetch(url, {
          method,
          headers,
          body: ['POST', 'PUT', 'PATCH'].includes(method) && body ? body : undefined,
        });
        const endTime = performance.now();
        const data = await response.text();

        if (responseSection) responseSection.hidden = false;

        if (statusBadge) {
          statusBadge.textContent = `${response.status} ${response.statusText}`;
          statusBadge.className = 'tryit-status-badge ' + (response.ok ? 'success' : 'error');
        }
        if (timeEl) timeEl.textContent = `${Math.round(endTime - startTime)}ms`;

        if (bodyEl) {
          try {
            bodyEl.textContent = JSON.stringify(JSON.parse(data), null, 2);
          } catch {
            bodyEl.textContent = data;
          }
        }
      } catch (err) {
        if (responseSection) responseSection.hidden = false;
        if (statusBadge) {
          statusBadge.textContent = 'Error';
          statusBadge.className = 'tryit-status-badge error';
        }
        if (bodyEl) bodyEl.textContent = String(err);
      }
    });
  }

  document.querySelectorAll('.api-tryit').forEach(el => initTryIt(el as HTMLElement));
  document.addEventListener('astro:page-load', () => {
    document.querySelectorAll('.api-tryit').forEach(el => initTryIt(el as HTMLElement));
  });
</script>
