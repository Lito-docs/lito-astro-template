---
/**
 * APIEndpoint - Display an API endpoint with method, path, and details
 * Redesigned with modern styling inspired by Mintlify/Stripe
 *
 * Usage:
 * <APIEndpoint method="GET" path="/users/{id}" description="Get a user by ID" />
 * <APIEndpoint method="POST" path="/users" auth="bearer" deprecated />
 */
import Icon from '../Icon.astro';

interface Props {
  method: "GET" | "POST" | "PUT" | "PATCH" | "DELETE" | "OPTIONS" | "HEAD";
  path: string;
  description?: string;
  deprecated?: boolean;
  auth?: "bearer" | "api-key" | "basic" | "none";
  baseUrl?: string;
}

const { method, path, description, deprecated = false, auth, baseUrl } = Astro.props;

const methodConfig: Record<string, { bg: string; text: string; icon: string }> = {
  GET: { bg: "bg-emerald-500/15", text: "text-emerald-600 dark:text-emerald-400", icon: "lucide:download" },
  POST: { bg: "bg-blue-500/15", text: "text-blue-600 dark:text-blue-400", icon: "lucide:plus" },
  PUT: { bg: "bg-amber-500/15", text: "text-amber-600 dark:text-amber-400", icon: "lucide:pencil" },
  PATCH: { bg: "bg-orange-500/15", text: "text-orange-600 dark:text-orange-400", icon: "lucide:wrench" },
  DELETE: { bg: "bg-red-500/15", text: "text-red-600 dark:text-red-400", icon: "lucide:trash-2" },
  OPTIONS: { bg: "bg-purple-500/15", text: "text-purple-600 dark:text-purple-400", icon: "lucide:settings" },
  HEAD: { bg: "bg-gray-500/15", text: "text-gray-600 dark:text-gray-400", icon: "lucide:eye" },
};

const config = methodConfig[method] || methodConfig.GET;
const endpointId = `endpoint-${Math.random().toString(36).slice(2, 9)}`;

// Format path with highlighted parameters
const formattedPath = path.replace(/\{([^}]+)\}/g, '<span class="path-param">{$1}</span>');
---

<div
  class:list={["api-endpoint not-prose group", { "deprecated": deprecated }]}
  id={endpointId}
  data-path={path}
  data-base-url={baseUrl}
>
  <div class="endpoint-header">
    <div class="endpoint-method-path">
      <span class:list={["method-badge", config.bg, config.text]}>
        {method}
      </span>
      <code class="endpoint-path" set:html={formattedPath} />
    </div>

    <div class="endpoint-actions">
      {auth && auth !== "none" && (
        <span class="auth-badge">
          <Icon name="lucide:lock" size={12} />
          {auth === "bearer" ? "Bearer" : auth === "api-key" ? "API Key" : "Basic"}
        </span>
      )}
      {deprecated && (
        <span class="deprecated-badge">
          <Icon name="lucide:alert-triangle" size={12} />
          Deprecated
        </span>
      )}
      <button class="copy-btn" aria-label="Copy endpoint" data-path={path}>
        <Icon name="lucide:copy" size={14} class="copy-icon" />
        <Icon name="lucide:check" size={14} class="check-icon" />
      </button>
    </div>
  </div>

  {description && (
    <p class="endpoint-description">{description}</p>
  )}

  <div class="endpoint-content">
    <slot />
  </div>
</div>

<style>
  @reference "../../styles/global.css";

  .api-endpoint {
    @apply my-6 rounded-xl border border-border bg-card overflow-hidden;
    box-shadow: var(--shadow-xs);
  }

  .api-endpoint.deprecated {
    opacity: 0.7;
  }

  .api-endpoint.deprecated:hover {
    opacity: 0.85;
  }

  .endpoint-header {
    @apply flex items-center justify-between gap-4 px-5 py-4;
    @apply border-b border-border;
    @apply bg-muted/50;
  }

  .endpoint-method-path {
    @apply flex items-center gap-3 min-w-0 flex-1;
  }

  .method-badge {
    @apply px-3 py-1.5 text-xs font-bold uppercase rounded-md;
    @apply flex-shrink-0 tracking-wide;
    letter-spacing: 0.05em;
  }

  .endpoint-path {
    @apply text-sm font-mono text-foreground truncate;
    @apply bg-transparent border-0 p-0;
  }

  .endpoint-path :global(.path-param) {
    @apply text-primary-600 font-semibold;
  }

  :global(.dark) .endpoint-path :global(.path-param) {
    @apply text-primary-400;
  }

  .endpoint-actions {
    @apply flex items-center gap-2 flex-shrink-0;
  }

  .auth-badge {
    @apply inline-flex items-center gap-1 px-2 py-1 text-xs font-medium;
    @apply text-muted-foreground bg-muted rounded-md;
  }

  .deprecated-badge {
    @apply inline-flex items-center gap-1 px-2 py-1 text-xs font-medium;
    @apply text-amber-600 bg-amber-500/10 rounded-md;
  }

  :global(.dark) .deprecated-badge {
    @apply text-amber-400;
  }

  .copy-btn {
    @apply p-2 rounded-lg text-muted-foreground;
    @apply hover:text-foreground hover:bg-muted;
    @apply transition-all duration-150;
    @apply relative;
  }

  .copy-btn .check-icon {
    @apply hidden text-success;
  }

  .copy-btn.copied .copy-icon {
    @apply hidden;
  }

  .copy-btn.copied .check-icon {
    @apply block;
  }

  .endpoint-description {
    @apply px-5 py-3 text-sm text-muted-foreground m-0;
    @apply border-b border-border bg-muted/30;
  }

  .endpoint-content {
    @apply p-5;
  }

  .endpoint-content:empty {
    @apply hidden;
  }
</style>

<script>
  function initEndpoints() {
    document.querySelectorAll('.api-endpoint .copy-btn').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const path = (btn as HTMLElement).dataset.path;
        if (path) {
          await navigator.clipboard.writeText(path);
          btn.classList.add('copied');
          setTimeout(() => btn.classList.remove('copied'), 2000);
        }
      });
    });
  }

  initEndpoints();
  document.addEventListener('astro:page-load', initEndpoints);
</script>
