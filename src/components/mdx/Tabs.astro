---
/**
 * Tabs - Tabbed content component
 * Usage:
 * <Tabs>
 *   <Tab title="npm">npm install package</Tab>
 *   <Tab title="yarn">yarn add package</Tab>
 * </Tabs>
 *
 * Alt usage with items prop:
 * <Tabs items={['npm', 'yarn']}>
 *   <Tab>npm content</Tab>
 *   <Tab>yarn content</Tab>
 * </Tabs>
 */
interface Props {
  items?: string[];
  defaultIndex?: number;
}

const { items, defaultIndex = 0 } = Astro.props;
const id = `tabs-${Math.random().toString(36).slice(2, 9)}`;

// If items not provided, we'll extract titles from Tab children via client-side JS
const hasItemsProp = Array.isArray(items) && items.length > 0;
---

<div
  class="tabs-container not-prose"
  data-tabs-id={id}
  data-default-index={defaultIndex}
>
  {
    hasItemsProp && (
      <div class="tabs-header" role="tablist">
        {items.map((item, index) => (
          <button
            role="tab"
            data-tab-index={index}
            class={`tab-button ${index === defaultIndex ? "active" : ""}`}
            aria-selected={index === defaultIndex}
          >
            {item}
          </button>
        ))}
      </div>
    )
  }
  <div
    class="tabs-header dynamic-tabs"
    role="tablist"
    style={hasItemsProp ? "display: none;" : ""}
  >
  </div>
  <div class="tabs-content">
    <slot />
  </div>
</div>

<style is:global>
  @reference "../../styles/global.css";
  .tabs-container {
    @apply my-6 rounded-lg border border-border bg-card overflow-hidden;
  }

  .tabs-header {
    @apply flex gap-0 border-b border-border;
    background: var(--muted);
  }

  .tab-button {
    @apply px-4 py-2 text-sm font-medium text-muted-foreground;
    @apply transition-colors duration-150;
    @apply cursor-pointer select-none;
    position: relative;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
  }

  .tab-button:hover:not(.active) {
    @apply text-foreground;
  }

  .tab-button.active {
    @apply text-primary-600 bg-card font-medium;
    border-bottom-color: var(--primary-500);
  }

  :global(.dark) .tab-button.active {
    @apply text-primary-400;
  }

  .tabs-content {
    @apply p-5 bg-card;
  }

  .tabs-content :global(p:first-child) {
    @apply mt-0;
  }

  .tabs-content :global(p:last-child) {
    @apply mb-0;
  }
</style>

<script>
  function initTabs() {
    document.querySelectorAll(".tabs-container").forEach((container) => {
      const defaultIndex = parseInt(
        container.getAttribute("data-default-index") || "0",
      );
      const dynamicHeader = container.querySelector(".dynamic-tabs");
      const staticHeader = container.querySelector(
        ".tabs-header:not(.dynamic-tabs)",
      );
      const panels = container.querySelectorAll(".tab-panel");

      // Check if we need to build tabs from Tab children
      // Skip if static buttons already exist (from items prop)
      const hasStaticButtons = staticHeader && staticHeader.querySelectorAll('[role="tab"]').length > 0;
      if (
        dynamicHeader &&
        panels.length > 0 &&
        !dynamicHeader.hasChildNodes() &&
        !hasStaticButtons
      ) {
        // Extract titles from Tab children
        panels.forEach((panel, index) => {
          const title = panel.getAttribute("data-title") || `Tab ${index + 1}`;
          const button = document.createElement("button");
          button.setAttribute("role", "tab");
          button.setAttribute("data-tab-index", String(index));
          button.className = `tab-button ${index === defaultIndex ? "active" : ""}`;
          button.setAttribute("aria-selected", String(index === defaultIndex));
          button.textContent = title;
          dynamicHeader.appendChild(button);
        });
        (dynamicHeader as HTMLElement).style.display = "flex";
        if (staticHeader) (staticHeader as HTMLElement).style.display = "none";
      }

      const buttons = container.querySelectorAll('[role="tab"]');

      // Get tab labels for label-based persistence
      const tabLabels = Array.from(buttons).map(
        (btn) => btn.textContent?.trim() || "",
      );

      // Determine initial active index: check sessionStorage for a saved label
      let activeIndex = defaultIndex;
      try {
        const saved = JSON.parse(
          sessionStorage.getItem("lito-tabs") || "{}",
        );
        const match = tabLabels.findIndex((label) => saved[label]);
        if (match >= 0) activeIndex = match;
      } catch {}

      // Initialize - show active tab
      buttons.forEach((btn, i) => {
        btn.classList.toggle("active", i === activeIndex);
        btn.setAttribute("aria-selected", String(i === activeIndex));
      });
      panels.forEach((panel, i) => {
        (panel as HTMLElement).style.display =
          i === activeIndex ? "block" : "none";
      });

      function selectTab(index: number) {
        buttons.forEach((btn, i) => {
          btn.classList.toggle("active", i === index);
          btn.setAttribute("aria-selected", String(i === index));
        });
        panels.forEach((panel, i) => {
          (panel as HTMLElement).style.display =
            i === index ? "block" : "none";
        });

        // Persist by label
        const label = tabLabels[index];
        if (label) {
          try {
            const saved = JSON.parse(
              sessionStorage.getItem("lito-tabs") || "{}",
            );
            // Clear other labels in this group, set selected
            tabLabels.forEach((l) => delete saved[l]);
            saved[label] = true;
            sessionStorage.setItem("lito-tabs", JSON.stringify(saved));
          } catch {}

          // Sync other tab groups on the same page that share this label
          document.querySelectorAll(".tabs-container").forEach((other) => {
            if (other === container) return;
            const otherButtons = other.querySelectorAll('[role="tab"]');
            const otherPanels = other.querySelectorAll(".tab-panel");
            const matchIdx = Array.from(otherButtons).findIndex(
              (btn) => btn.textContent?.trim() === label,
            );
            if (matchIdx >= 0) {
              otherButtons.forEach((btn, i) => {
                btn.classList.toggle("active", i === matchIdx);
                btn.setAttribute("aria-selected", String(i === matchIdx));
              });
              otherPanels.forEach((panel, i) => {
                (panel as HTMLElement).style.display =
                  i === matchIdx ? "block" : "none";
              });
            }
          });
        }
      }

      buttons.forEach((button) => {
        button.addEventListener("click", () => {
          const index = parseInt(
            (button as HTMLElement).dataset.tabIndex || "0",
          );
          selectTab(index);
        });
      });
    });
  }

  initTabs();
  document.addEventListener("astro:page-load", initTabs);
</script>
