---
/**
 * Tabs - Tabbed content component
 * Usage:
 * <Tabs>
 *   <Tab title="npm">npm install package</Tab>
 *   <Tab title="yarn">yarn add package</Tab>
 * </Tabs>
 *
 * Alt usage with items prop:
 * <Tabs items={['npm', 'yarn']}>
 *   <Tab>npm content</Tab>
 *   <Tab>yarn content</Tab>
 * </Tabs>
 */
interface Props {
  items?: string[];
  defaultIndex?: number;
}

const { items, defaultIndex = 0 } = Astro.props;
const id = `tabs-${Math.random().toString(36).slice(2, 9)}`;

// If items not provided, we'll extract titles from Tab children via client-side JS
const hasItemsProp = Array.isArray(items) && items.length > 0;
---

<div
  class="tabs-container not-prose"
  data-tabs-id={id}
  data-default-index={defaultIndex}
>
  {
    hasItemsProp && (
      <div class="tabs-header" role="tablist">
        {items.map((item, index) => (
          <button
            role="tab"
            data-tab-index={index}
            class={`tab-button ${index === defaultIndex ? "active" : ""}`}
            aria-selected={index === defaultIndex}
          >
            {item}
          </button>
        ))}
      </div>
    )
  }
  <div
    class="tabs-header dynamic-tabs"
    role="tablist"
    style={hasItemsProp ? "display: none;" : ""}
  >
  </div>
  <div class="tabs-content">
    <slot />
  </div>
</div>

<style is:global>
  @reference "../../styles/global.css";
  .tabs-container {
    @apply my-6 rounded-lg border border-border bg-card overflow-hidden;
    box-shadow: var(--shadow-sm);
  }

  .tabs-header {
    @apply flex gap-1 p-2 border-b border-border;
    background: linear-gradient(to bottom, var(--muted), oklch(from var(--muted) l c h / 0.5));
  }

  .tab-button {
    @apply px-4 py-2.5 text-sm font-medium text-muted-foreground;
    @apply rounded-md;
    @apply transition-all duration-150 ease-out;
    @apply cursor-pointer select-none;
    position: relative;
  }

  /* Hover state */
  .tab-button:hover:not(.active) {
    @apply text-foreground bg-background;
    transform: translateY(-1px);
  }

  /* Focus state */
  .tab-button:focus-visible {
    @apply outline-none;
    box-shadow: 0 0 0 2px var(--primary-100), 0 0 0 1px var(--primary-500);
  }

  /* Active/pressed state */
  .tab-button:active:not(.active) {
    @apply bg-muted scale-[0.98];
  }

  /* Selected state with bottom indicator */
  .tab-button.active {
    @apply text-primary-700 bg-background font-semibold;
    box-shadow: var(--shadow-xs);
  }

  .tab-button.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--primary-500);
    border-radius: 2px 2px 0 0;
  }

  :global(.dark) .tab-button.active {
    @apply text-primary-500;
  }

  .tabs-content {
    @apply p-5 bg-card;
  }

  .tabs-content :global(p:first-child) {
    @apply mt-0;
  }

  .tabs-content :global(p:last-child) {
    @apply mb-0;
  }
</style>

<script>
  function initTabs() {
    document.querySelectorAll(".tabs-container").forEach((container) => {
      const defaultIndex = parseInt(
        container.getAttribute("data-default-index") || "0",
      );
      const dynamicHeader = container.querySelector(".dynamic-tabs");
      const staticHeader = container.querySelector(
        ".tabs-header:not(.dynamic-tabs)",
      );
      const panels = container.querySelectorAll(".tab-panel");

      // Check if we need to build tabs from Tab children
      if (
        dynamicHeader &&
        panels.length > 0 &&
        !dynamicHeader.hasChildNodes()
      ) {
        // Extract titles from Tab children
        panels.forEach((panel, index) => {
          const title = panel.getAttribute("data-title") || `Tab ${index + 1}`;
          const button = document.createElement("button");
          button.setAttribute("role", "tab");
          button.setAttribute("data-tab-index", String(index));
          button.className = `tab-button ${index === defaultIndex ? "active" : ""}`;
          button.setAttribute("aria-selected", String(index === defaultIndex));
          button.textContent = title;
          dynamicHeader.appendChild(button);
        });
        (dynamicHeader as HTMLElement).style.display = "flex";
        if (staticHeader) (staticHeader as HTMLElement).style.display = "none";
      }

      const buttons = container.querySelectorAll('[role="tab"]');

      // Initialize - show only the default tab
      panels.forEach((panel, index) => {
        (panel as HTMLElement).style.display =
          index === defaultIndex ? "block" : "none";
      });

      buttons.forEach((button) => {
        button.addEventListener("click", () => {
          const index = parseInt(
            (button as HTMLElement).dataset.tabIndex || "0",
          );

          // Update buttons
          buttons.forEach((btn, i) => {
            btn.classList.toggle("active", i === index);
            btn.setAttribute("aria-selected", String(i === index));
          });

          // Update panels
          panels.forEach((panel, i) => {
            (panel as HTMLElement).style.display =
              i === index ? "block" : "none";
          });
        });
      });
    });
  }

  initTabs();
  document.addEventListener("astro:page-load", initTabs);
</script>
